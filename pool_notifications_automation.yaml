# Home Assistant Automation for Pool System Notifications
#
# INSTALLATION OPTIONS:
#
# Option 1 - Via Home Assistant UI (RECOMMENDED):
# 1. Go to Settings → Automations & Scenes → Create Automation
# 2. Click the 3-dots menu → Edit in YAML
# 3. Copy the YAML below (starting from "alias:")
# 4. Save
#
# Option 2 - Add to automations.yaml file:
# 1. Copy the YAML below (starting from "alias:")
# 2. Paste at the end of /config/automations.yaml
# 3. Make sure it's at the same indentation level as other automations (no extra spaces)
# 4. Reload automations or restart Home Assistant
#
# Option 3 - Add to configuration.yaml:
# 1. Uncomment the "automation:" line below
# 2. Copy the entire block to configuration.yaml
# 3. Restart Home Assistant

# Uncomment the line below ONLY if adding to configuration.yaml:
# automation:

# Copy from here if adding to automations.yaml or using HA UI:
- alias: "Pool System - Critical Error Notifications"
  description: "Send Pushover notifications when pool system errors occur"
  triggers:
    - entity_id: sensor.esp32_pileta_pool_system_error
      trigger: state
  conditions:
    # Only trigger when error message is not empty
    - condition: template
      value_template: >-
        {{ trigger.to_state.state != '' and trigger.to_state.state != 'unknown'
        and trigger.to_state.state != 'unavailable' }}
  actions:
    # Send Pushover notification
    - data:
        title: "Pool System Alert"
        message: "⚠️ {{ trigger.to_state.state }}"
        priority: "0"
      action: notify.pushover

    # Clear the error message on ESP32 to prevent repeat notifications
    - action: esphome.esp32_pileta_clear_error_message
  mode: single

# IMPORTANT NOTES:
# 1. This automation sends notifications immediately when errors occur
# 2. After sending notification, it clears the error message on ESP32
# 3. Daily throttling is handled by ESP32 (notif_*_sent flags reset at midnight)
# 4. Empty string sensor value = no active errors
# 5. Mode 'single' prevents duplicate notifications while processing
# 6. Make sure notify.pushover service is configured in Home Assistant
# 7. ESPHome service esphome.esp32_pileta_clear_error_message automatically available

# INSTALLATION:
# 1. Copy this automation to your Home Assistant
# 2. Restart Home Assistant or reload automations
# 3. Test using the ESP32 test button: button.esp32_pileta_test_pushover_notification
# 4. Monitor ESP32 logs to see when error states are set

# ERROR TYPES MONITORED:
# - IMX parameter auto-correction
# - Sensor range violations (water/heater)
# - Sensor staleness (>5 min without update)
# - Pump desynchronization
# - 8-hour runtime watchdog

# CUSTOMIZATION:
# - Change priority (0 = normal, 1 = high, 2 = emergency)
# - Add actions (e.g., turn on a light, send SMS)
# - Filter specific error types with additional conditions
# - Add notification history tracking
